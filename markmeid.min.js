"use strict";var e;!function(e){e.ActivateApplication="activate-app",e.DeactivateApplication="deactivate-app",e.ActivateContextMenu="activate-context-menu",e.DeactivateContextMenu="deactivate-context-menu",e.SetConfig="set-config",e.SetProfile="set-profile",e.SetNotes="set-notes",e.AddNote="add-note",e.AddNotes="add-notes",e.RemoveNotes="remove-notes",e.SetFetchStatus="set-fetch-status"}(e||(e={}));const t=()=>({type:e.ActivateApplication}),o=()=>({type:e.DeactivateApplication}),n=t=>({type:e.SetFetchStatus,payload:t}),i=t=>({type:e.SetProfile,payload:t}),a=t=>({type:e.SetNotes,payload:t});var r;!function(e){e.Initial="initial",e.Loading="loading",e.Updating="updating",e.Success="success",e.Error="error"}(r||(r={}));const s=((e,t)=>{let o=e(t,{type:"__INIT__"}),n=[];return{getState:()=>o,dispatch:t=>{const i=o;o=e(o,t),n.forEach((e=>e(i,o)))},subscribe:e=>(n.push(e),()=>{n=n.filter((t=>t!==e))})}})(((t,o)=>{switch(o.type){case e.ActivateApplication:return Object.assign(Object.assign({},t),{active:!0});case e.DeactivateApplication:return Object.assign(Object.assign({},t),{active:!1});case e.ActivateContextMenu:return Object.assign(Object.assign({},t),{contextMenuActive:!0});case e.DeactivateContextMenu:return Object.assign(Object.assign({},t),{contextMenuActive:!1});case e.SetConfig:return Object.assign(Object.assign({},t),{config:Object.assign(Object.assign({},t.config),o.payload)});case e.SetNotes:return Object.assign(Object.assign({},t),{notes:o.payload});case e.AddNote:return Object.assign(Object.assign({},t),{notes:[...t.notes,o.payload]});case e.AddNotes:return Object.assign(Object.assign({},t),{notes:[...t.notes,...o.payload]});case e.RemoveNotes:return Object.assign(Object.assign({},t),{notes:[]});case e.SetFetchStatus:return Object.assign(Object.assign({},t),{fetchStatus:o.payload});default:return t}}),{active:!1,contextMenuActive:!0,notes:[],config:{uid:null,selectorDepth:7,urlFiltering:!0},profile:null,fetchStatus:r.Initial}),d=e=>e.active,l=e=>e.contextMenuActive,c=e=>e.notes,p=e=>e.config.uid,m=e=>e.config.urlFiltering,u=e=>{const t=f(e),o=h(e);return`${t}${o>1?`:nth-of-type(${o})`:""}`},f=e=>{const t=e.id?`#${x(e.id)}`:"",o=g(e.classList);return`${e.tagName.toLowerCase()}${t}${o}`},h=e=>{var t;return Array.from((null===(t=e.parentElement)||void 0===t?void 0:t.children)||[]).filter((t=>t.tagName===e.tagName)).indexOf(e)+1},x=e=>e.replace(/^(\d)/,"\\3$1 ").replace(/([.,:/{}\[\]])/g,"\\$1"),g=e=>{let t="";if(e&&e.length>0){const o=Array.from(e).map(x);o.length>0&&(t+="."+o.join("."))}return t},v=e=>{const t=window.getComputedStyle(e);return"auto"===t.overflow||"auto"===t.overflowX||"auto"===t.overflowY||"scroll"===t.overflow||"scroll"===t.overflowX||"scroll"===t.overflowY},b=(e,t)=>{if(!e||t<1)return{query:null};let o,n=e,i=[];for(let e=0;e<t&&n;e++){const a=t===e+1?f(n):u(n);if(i.unshift(a),v(n)&&(o=a),"BODY"===n.tagName)break;n=n.parentElement}return{query:i.join(">"),overflowNode:o}},k=e=>{if(!e)return null;const t=window.scrollX||document.documentElement.scrollLeft,o=window.scrollY||document.documentElement.scrollTop;try{const n=e.getBoundingClientRect();return{top:n.top+o,left:n.left+t,w:n.width,h:n.height}}catch(e){return console.log(e),null}},y=e=>{const{query:t,content:o}=e,n=document.querySelectorAll(t);return n&&0!==n.length?n.length>1?((e,t)=>{for(const o of e)if(o.textContent.trim()===t.trim())return o;return null})(n,o):n[0]:null},w=e=>{if(!e)return null;const t=document.querySelector(e);return t||null},E=(e,t)=>({top:e.top+t.y-2,left:e.left+t.x-2}),C=e=>{const t=e.target,{selectorDepth:o}=s.getState().config;const n=t.getBoundingClientRect(),i=Math.round(e.clientX-n.left),a=Math.round(e.clientY-n.top);return Object.assign({position:{x:i,y:a},content:t.innerText},b(t,o))},N=e=>e?e.getBoundingClientRect():null;var L,j;!function(e){e.Closed="closed",e.Open="open",e.Inactive="inactive"}(L||(L={})),function(e){e.Bug="bug",e.Feature="feature",e.Question="question"}(j||(j={}));const S=document.createElement("div");S.setAttribute("data-markmeid-widget","active"),S.setAttribute("id","markmeid");const $=S.attachShadow({mode:"open"}),M=document.createElement("style");let z;M.textContent='@import url("https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700;800&display=swap");*{box-sizing:border-box;font-family:Manrope,sans-serif}button{border:unset}#markmeid-wrapper{inset:0;overflow:hidden;pointer-events:none;position:absolute}.markmeid-note-node{background-color:#c24808;border:2px solid #e8e8e8;border-radius:0 50% 50% 50%;color:#fff;cursor:pointer;font-size:13px;font-weight:600;height:30px;line-height:26px;opacity:.95;pointer-events:all;position:absolute;text-align:center;text-transform:capitalize;transition:box-shadow .2s ease,filter .2s ease,left .2s,top .2s;width:30px;z-index:999999}.bug-highlight{background-color:#c02020}.feature-highlight{background-color:#0e7490}.question-highlight{background-color:#a21caf}.markmeid-note-node:hover{box-shadow:0 0 2px 2px hsla(0,0%,96%,.8);filter:brightness(1.1)}.markmeid-menu{align-items:center;background-color:#d65004;border-radius:4px;bottom:1rem;cursor:pointer;display:flex;justify-content:center;opacity:.5;padding:4px;pointer-events:all;position:fixed;right:1rem;z-index:99999999;&:hover{filter:brightness(.95)}}.markmeid-menu-block{background-color:#fff;border-radius:4px;bottom:3rem;box-shadow:0 1px 4px rgba(0,0,0,.16);display:none;pointer-events:all;position:fixed;right:1rem;width:200px;z-index:99999999}.markmeid-actions-block{border-top:1px solid #e5e5e5;display:flex;flex-direction:row;gap:4px;margin-top:8px;padding:8px 0;pointer-events:all}.note-close-btn{background-color:#d7d7d7;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;padding:2px 8px;&:hover{filter:brightness(.95)}}.shadowed-menu-button{box-shadow:0 0 3px 2px rgba(132,175,190,.3)}.markmeid-menu-title{color:#fffffd;font-size:12px;font-weight:700;padding:0 8px 0 4px}.markmeid-menu-block-title{color:#9f9f9f;font-size:12px;padding:6px}.markmeid-menu-block-note-list{border-bottom:1px solid #e9e9e9;color:#9f9f9f;font-size:12px;margin-bottom:8px;max-height:240px;overflow:auto;padding:8px;& li{padding:4px 0}}.markmeid-menu-block-info{border-bottom:1px solid #e9e9e9;color:#9f9f9f;font-size:12px;margin-bottom:8px;padding:8px}.markmeid-menu-block-info-title,.markmeid-menu-block-note-list-title{color:#d44f06;font-size:13px;font-weight:700;padding:4px 8px}.markmeid-menu-block-note-list-element-type{border-radius:4px;color:#fff;font-size:11px;padding:1px 4px}.markmeid-menu-block-note-list-element-value{color:#424242;font-size:12px;padding:2px 6px}.markmeid-menu-icon{align-items:center;background-color:#ae4a11;border-radius:2px;color:#fff;display:flex;height:16px;justify-content:center;padding:2px;text-align:center;width:16px;& svg{height:12px;width:12px}&:hover{background-color:#983f0d}}.markmeid-cursor-icon{align-items:center;background-color:#ae4a11;border-radius:2px;color:#fff;display:flex;height:16px;justify-content:center;margin-right:2px;padding:2px;text-align:center;width:16px;& svg{height:12px;width:12px}&:hover{background-color:#983f0d}}.markmeid-cursor-icon.context-disabled{background-color:#a9a9a9;color:#fff}#markmeid-context-menu{background-color:#fff;border-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.16);display:none;flex-wrap:nowrap;height:200px;padding:4px;pointer-events:all;position:absolute;width:164px;z-index:9999999}.markmeid-context-menu-title{color:#cdaca0;font-size:11px;margin-bottom:4px}.markmeid-context-menu-textarea{border:1px solid #ccc;border-radius:4px;font-size:12px;height:140px;margin-bottom:2px;padding:2px 4px}.markmeid-context-menu-add-button{background-color:#c24907;border-radius:4px;color:#fff;cursor:pointer;font-size:12px;font-weight:600;outline:none;padding:2px 8px;&:hover{filter:brightness(.95)}&:disabled{background-color:#858585;cursor:not-allowed;opacity:.6;pointer-events:none}}.markmeid-context-menu-controls{display:flex;flex-direction:row;justify-content:space-between}.markmeid-context-menu-type-select{border:1px solid #c5c5c5;border-radius:4px;font-size:12px;padding:1px 4px;width:110px}.markmeid-context-menu-actions-block{display:flex;flex-direction:column}.markmeid-note-popup{background-color:#fff;border-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.16);display:none;padding:24px 8px 8px;pointer-events:all;position:absolute;width:220px;z-index:9999991}.markmeid-note-popup-content{background-color:#fff;font-size:13px;padding-top:4px}.markmeid-note-popup-close-button{color:#1f2937;cursor:pointer;height:16px;opacity:.5;position:absolute;right:4px;top:4px;width:16px;&:hover{opacity:.9}}.markmeid-note-popup-title{color:#cdaca0;font-size:11px;left:7px;margin-bottom:8px;position:absolute;top:4px}.markmeid-login-popup{background-color:#fff;border-radius:4px;bottom:3rem;box-shadow:0 1px 4px rgba(0,0,0,.16);display:none;padding:10px;pointer-events:all;position:fixed;right:1rem;width:200px;z-index:9999992}.markmeid-login-title{color:#cdaca0;font-size:12px;margin-bottom:8px}.markmeid-note-type{border-radius:4px;color:#fff;font-size:11px;font-weight:700;padding:1px 4px;width:fit-content}.markmeid-note-type-bug{background-color:#ef4444}.markmeid-note-type-feature{background-color:#0f766e}.markmeid-note-type-question{background-color:#d946ef}.markmeid-login-popup-form-input{border:1px solid #ccc;border-radius:4px;color:#515151;font-size:13px;margin-bottom:4px;padding:4px 8px;width:100%}.markmeid-login-popup-form-submit-button{background-color:#ea580c;border-radius:4px;color:#fff;cursor:pointer;font-size:13px;font-weight:700;margin-top:12px;padding:4px 8px;width:100%}.markmeid-login-popup-form-input-label{color:#717375;font-size:13px;font-weight:500}.note-date{color:#0e7490;font-size:11px}.note-status{color:#676767;font-size:11px;font-weight:700;text-transform:capitalize}.note-user{border-top:1px solid #e4e4e4;color:#614433;font-size:12px;margin-top:6px;padding:2px 0}.note-closed{opacity:.5}.note-comments,.note-value{border-left:2px solid #d54f05b0;max-height:90px;min-height:60px;overflow:auto;overflow-wrap:break-word;padding:2px 4px}.note-comments-title{color:#ae4a11;font-size:12px;font-weight:700;margin:8px 0 2px}.note-comment-date{color:#0e7490;font-size:11px}.note-comment-add-btn{background-color:#d65004;border-radius:0 4px 4px 0;color:#fff;font-size:12px;font-weight:700;padding:1px 6px}.note-comment-add-input{border:1px solid #ccc;border-radius:4px 0 0 4px;color:#515151;font-size:12px;outline:none;padding:1px 8px;width:100%}.note-comment-user{color:#0e7490;font-size:12px;font-weight:700}.markmeid-flex{display:flex}.markmeid-flex,.markmeid-flex-row{flex-direction:row}.markmeid-flex-col{flex-direction:column}.markmeid-justify-between{justify-content:space-between}.markmeid-mb-1{margin-bottom:2px}.markmeid-mb-2{margin-bottom:4px}.markmeid-mb-3{margin-bottom:6px}.markmeid-mb-4{margin-bottom:8px}.markmeid-loader{animation:rotation 1s linear infinite;border:1px solid;border-color:#fff #fff transparent;border-radius:50%;box-sizing:border-box;display:block;height:8px;margin:2px;width:8px}@keyframes rotation{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}',$.appendChild(M),z=document.createElement("div"),z.id="markmeid-wrapper",$.appendChild(z);const A=document.createElement("div");A.className="markmeid-menu";const T=document.createElement("div");T.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>',T.className="markmeid-menu-icon";const O=document.createElement("div");O.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.042 21.672 13.684 16.6m0 0-2.51 2.225.569-9.47 5.227 7.917-3.286-.672Zm-7.518-.267A8.25 8.25 0 1 1 20.25 10.5M8.288 14.212A5.25 5.25 0 1 1 17.25 10.5" /></svg>',O.className="markmeid-cursor-icon",O.title="Markmeid context active",s.subscribe(((e,t)=>{const{fetchStatus:o}=t;switch(o){case r.Loading:T.innerHTML="<span class='markmeid-loader'></span>";break;case r.Error:T.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>';break;default:T.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>'}}));const B=document.createElement("div");B.textContent="M채rkmeid",B.className="markmeid-menu-title",A.appendChild(B),A.appendChild(O),A.appendChild(T);const P=document.createElement("div");P.className="markmeid-menu-block";const D=document.createElement("div");D.className="markmeid-note-popup-close-button",D.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',P.appendChild(D);const H=document.createElement("div");H.className="markmeid-menu-block-title",H.innerText="Markmeid",P.appendChild(H);const I=document.createElement("div");I.className="markmeid-menu-block-note-list-title",I.innerText="Notes list",P.appendChild(I);const q=document.createElement("ul");q.className="markmeid-menu-block-note-list",P.appendChild(q);const F=document.createElement("div");F.className="markmeid-menu-block-info-title",F.innerText="Info",P.appendChild(F);const U=document.createElement("div");U.className="markmeid-menu-block-info",U.innerHTML="<div>Organization: CodeCustoms</div>",P.appendChild(U),z.appendChild(A),z.appendChild(P),document.body.appendChild(S);const R=document.createElement("div");R.id="markmeid-note-popup-block",R.className="markmeid-note-popup";const Y=document.createElement("div");Y.className="markmeid-note-popup-content";const Q=document.createElement("span");Q.className="markmeid-note-popup-title",Q.innerText="M채rkmeid";const X=document.createElement("span");X.className="markmeid-note-popup-close-button",X.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',R.appendChild(Q),R.appendChild(X),R.appendChild(Y),X.addEventListener("click",(()=>{R.style.display="none"}));const _=document.createElement("div");_.id="markmeid-context-menu";const J=document.createElement("div");J.className="markmeid-context-menu-actions-block";const W=document.createElement("div");W.className="markmeid-context-menu-title",W.textContent="M채rkmeid";const G=document.createElement("textarea");G.className="markmeid-context-menu-textarea",G.rows=3;const K=document.createElement("div");K.className="markmeid-context-menu-controls";const V=document.createElement("select");V.className="markmeid-context-menu-type-select";[{title:"Bug",value:"bug"},{title:"Feature",value:"feature"},{title:"Question",value:"question"}].forEach((({title:e,value:t,disabled:o})=>{const n=document.createElement("option");n.text=e,n.value=t,n.disabled=o,V.add(n)})),K.appendChild(V);const Z=document.createElement("button");Z.textContent="Add",Z.className="markmeid-context-menu-add-button",K.appendChild(Z),Z.disabled=""===G.value.trim(),G.addEventListener("input",(()=>{Z.disabled=""===G.value.trim()})),G.addEventListener("click",(e=>{e.stopPropagation()})),Z.addEventListener("click",(e=>{e.stopPropagation()})),V.addEventListener("click",(e=>{e.stopPropagation()}));const ee=document.createElement("span");ee.className="markmeid-note-popup-close-button",ee.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',_.appendChild(ee),_.appendChild(W),J.appendChild(G),J.appendChild(K),_.appendChild(J),z.appendChild(_);const te="fkdjfhofh34o2fiujugh24387gh23kjefgo2348fg743gp",oe="https://api.markmeid.com",ne="markmeid-x-token",ie=()=>localStorage.getItem(ne)||null,ae=(e,t)=>{let o=null;return(...n)=>{null!==o&&clearTimeout(o),o=window.setTimeout((()=>{o=null,e(...n)}),t)}},re=e=>{e.filter((({page:{url:e}})=>location.pathname===e)).forEach((e=>{const t=document.createElement("li");var o;t.addEventListener("mouseover",(()=>{Ue[e.uid].note.style.boxShadow="0 0 2px 2px hsla(0,0%,96%,.8)"})),t.addEventListener("mouseout",(()=>{Ue[e.uid].note.style.boxShadow="none"})),t.innerHTML=`<span class="markmeid-menu-block-note-list-element-type ${o=e.type,o===j.Bug?"bug-highlight":o===j.Question?"question-highlight":o===j.Feature?"feature-highlight":void 0}">${e.type}</span><span class="markmeid-menu-block-note-list-element-value">${e.value}</span>`,q.appendChild(t)}))},se=()=>{P.style.display="none",[...q.getElementsByTagName("li")].forEach((e=>e.remove()))},de=e=>{e.stopPropagation(),e.preventDefault(),le()},le=()=>{const t=s.getState();d(t)&&(l(t)?(s.dispatch({type:e.DeactivateContextMenu}),O.classList.add("context-disabled"),O.title="Markmeid context disabled"):(s.dispatch({type:e.ActivateContextMenu}),O.classList.remove("context-disabled"),O.title="Markmeid context active"))},ce=()=>{window.addEventListener("keydown",(e=>{e.ctrlKey&&"m"===e.key&&le()}))},pe=()=>{window.removeEventListener("keydown",le)},me=e=>{if(d(s.getState())){e.stopPropagation(),e.preventDefault();const t=c(s.getState());re(t),"block"===P.style.display?se():P.style.display="block"}else se()},ue=()=>{d(s.getState())&&(A.style.opacity="1",A.classList.add("shadowed-menu-button")),T.addEventListener("click",me),O.addEventListener("click",de),D.addEventListener("click",se),A.addEventListener("click",(async()=>{const i=d(s.getState()),l=ie();if(i){We(),pe(),se(),Ee.style.display="none",A.style.opacity="0.5",A.classList.remove("shadowed-menu-button"),s.dispatch({type:e.RemoveNotes}),Ye.hideNotesByClassName(),s.dispatch(o());const t=document.getElementById("markmeid-note-popup-block");t&&(t.style.display="none")}else{if(s.dispatch(t()),A.style.opacity="1",A.classList.add("shadowed-menu-button"),!l)return void je.drawLoginPopup(z);s.dispatch(n(r.Loading)),s.dispatch(a(await Oe.getNotes())),s.dispatch(n(r.Success)),Je(),ce()}}))},fe=ce,he=pe,xe=document.createElement("form"),ge=document.createElement("label");ge.className="markmeid-login-popup-form-input-label",ge.textContent="Login:";const ve=document.createElement("input");ve.type="text",ve.name="username",ve.className="markmeid-login-popup-form-input";const be=document.createElement("label");be.className="markmeid-login-popup-form-input-label",be.textContent="Password:";const ke=document.createElement("input");ke.type="password",ke.name="password",ke.className="markmeid-login-popup-form-input";const ye=document.createElement("button");ye.className="markmeid-login-popup-form-submit-button",ye.textContent="Login";const we=document.createElement("div");we.textContent="M채rkmeid",we.className="markmeid-login-title",xe.appendChild(we),xe.appendChild(ge),xe.appendChild(ve),xe.appendChild(document.createElement("br")),xe.appendChild(be),xe.appendChild(ke),xe.appendChild(document.createElement("br")),xe.appendChild(ye);const Ee=document.createElement("div");Ee.appendChild(xe),Ee.className="markmeid-login-popup";const Ce=document.createElement("div");Ce.className="markmeid-note-popup-close-button",Ce.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',Ce.addEventListener("click",(()=>{Ee.style.display="none",A.style.opacity="0.5",A.classList.remove("shadowed-menu-button"),s.dispatch(o()),he()})),Ee.appendChild(Ce);const Ne=async e=>{try{const o=await fetch(`${oe}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json","x-markmeid-key":te,"x-m-client":"web"},body:JSON.stringify(e)});if(!o.ok)return new Error(`HTTP error! Status: ${o.status}`);const n=await o.json();return t=n.access_token,localStorage.setItem(ne,t),!0}catch(e){return console.error("Error:",e),!1}var t},Le=async()=>{try{const e=await fetch(`${oe}/profile`,{method:"GET",headers:{"Content-Type":"application/json","x-markmeid-key":te,Authorization:`Bearer ${ie()}`}});return e.ok?e.json():new Error(`HTTP error! Status: ${e.status}`)}catch(e){return console.error("Error:",e),null}};xe.onsubmit=async e=>{e.preventDefault();const d=ve.value,l=ke.value;s.dispatch(n(r.Loading));await Ne({login:d,password:l})?(Ee.style.display="none",s.dispatch(i(await Le())),s.dispatch(a(await Oe.getNotes())),fe(),s.dispatch(n(r.Success)),s.dispatch(t()),A.style.opacity="1",A.classList.add("shadowed-menu-button")):(s.dispatch(n(r.Error)),s.dispatch(o()))};const je={drawLoginPopup:e=>{e.appendChild(Ee),Ee.style.display="block"}},{getState:Se}=s;let $e=null;const Me=async e=>{const t=p(Se());if(!t)throw Error("uid is not defined");try{const o=await fetch(`${oe}/note`,{method:"POST",headers:{"Content-Type":"application/json","x-markmeid-key":te,Authorization:`Bearer ${ie()}`,"x-app-uid":t,"x-m-client":"web"},body:JSON.stringify(e)});return o.ok?await o.json():(console.log(o.status),{})}catch(e){console.error("Error:",e)}},ze=async()=>{$e&&$e.abort(),$e=new AbortController;const e=p(Se());if(!e)throw Error("uid is not defined");try{const t=await fetch(`${oe}/note`,{headers:{"Content-Type":"application/json","x-markmeid-key":te,Authorization:`Bearer ${ie()}`,"x-app-uid":e,"x-m-client":"web"},signal:$e.signal}),o=await t.json();return $e=null,t.ok?o:(401!==o.statusCode&&403!==o.statusCode||(localStorage.removeItem(ne),je.drawLoginPopup(z)),[])}catch(e){if("AbortError"===e.name)return[];console.error(e)}},Ae=async(e,t)=>{try{const o=p(Se());if(!o)throw Error("uid is not defined");const n=await fetch(`${oe}/note/${e}`,{method:"PUT",headers:{"Content-Type":"application/json","x-markmeid-key":te,Authorization:`Bearer ${ie()}`,"x-app-uid":o,"x-m-client":"web"},body:JSON.stringify(t)});return n.ok?await n.json():(console.log(n.status),{})}catch(e){console.error("Error:",e)}},Te=async(e,t)=>{const o=p(Se());if(!o)throw Error("uid is not defined");try{const n=await fetch(`${oe}/comment`,{method:"POST",headers:{"Content-Type":"application/json","x-markmeid-key":te,Authorization:`Bearer ${ie()}`,"x-app-uid":o,"x-m-client":"web"},body:JSON.stringify({value:t,noteId:e})});return n.ok?await n.json():(console.log(n.status),{})}catch(e){console.error("Error:",e)}},Oe={getNotes:async()=>{try{return await ze()}catch(e){return console.error("Couldn't fetch the data"),[]}},addNote:async t=>{try{const n=await Me(t);return s.dispatch((o=n,{type:e.AddNote,payload:o})),t}catch(e){return null}var o}},Be=e=>`<ul id="markmeid-comments-list">${(null==e?void 0:e.map((e=>{var t;return`<li class="markmeid-mb-4"><div class="markmeid-flex markmeid-flex-col"><div class="markmeid-flex markmeid-flex-row markmeid-justify-between markmeid-mb-1"><div class="note-comment-user">${null===(t=e.user)||void 0===t?void 0:t.email}</div><div class="note-comment-date">${new Date(e.createdAt).toLocaleDateString()}</div></div><div>${e.value}</div></div></li>`})).join(""))||""}</ul>`,Pe=e=>{switch(e){case j.Bug:return"markmeid-note-type-bug";case j.Feature:return"markmeid-note-type-feature";case j.Question:return"markmeid-note-type-question"}},De=(e,t)=>{t.addEventListener("click",(()=>{(e=>{var t;const o=document.createElement("div");o.className="note-comment-add-block markmeid-flex markmeid-flex-row markmeid-justify-between";const n=document.createElement("input");n.className="note-comment-add-input";const i=document.createElement("button");i.innerText="Add",i.className="note-comment-add-btn",i.addEventListener("click",(async()=>{try{const t=await Te(e.id,n.value);n.value="";const o=document.getElementById("markmeid-comments-list"),i=document.createElement("li");i.innerHTML=`<li class="markmeid-mb-2"><div class="markmeid-flex markmeid-flex-col"><div class="markmeid-flex markmeid-flex-row markmeid-justify-between markmeid-mb-1"><div class="note-comment-user">${null==t?void 0:t.email}</div><div class="note-comment-date">${new Date(t.createdAt).toLocaleDateString()}</div></div><div>${t.value}</div></div></li>`,o.appendChild(i)}catch(e){console.log(e)}})),o.appendChild(n),o.appendChild(i);const a=document.createElement("div");a.className="markmeid-actions-block";const r=document.createElement("button");r.innerText=e.status===L.Closed?"Re-open":"Close",r.className="note-close-btn",r.addEventListener("click",(async()=>{try{const t=e.status===L.Closed?L.Open:L.Closed;await Ae(e.id,{status:t}),R.style.display="none",Ye.redrawNote(Object.assign(Object.assign({},e),{status:t}))}catch(e){console.log(e)}})),a.appendChild(r);const s=e.createdAt?new Date(e.createdAt).toLocaleDateString():(new Date).toLocaleDateString();Y.innerHTML=`\n        <div class="markmeid-flex markmeid-flex-row markmeid-justify-between"><div class="markmeid-note-type ${Pe(e.type)}">${e.type}</div><div class="note-status">${e.status}</div><div class="note-date">${s}</div></div>\n        <div class="note-user">By: <b>${(null===(t=null==e?void 0:e.user)||void 0===t?void 0:t.email)||"User"}</b></div>\n        <div class="note-value">${e.value}</div>\n        <div class="note-comments-title">Comments</div>\n        <div class="note-comments markmeid-mb-4">${Be(e.comments)}</div>\n      `,Y.appendChild(o),Y.appendChild(a)})(e);const o=window.innerWidth-t.offsetLeft,n=window.innerHeight-t.offsetTop;R.style.left=o>=220?t.offsetLeft-2+"px":t.offsetLeft-220+26+"px",R.style.top=n>=320?t.offsetTop-2+"px":t.offsetTop-320+"px",R.style.display="block"}))},He=()=>{try{return crypto.randomUUID()}catch(e){return console.warn("RandomUUID function failed. Seems connection is not secured. Using polyfill"),"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(e=>(Number(e)^crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(e)/4).toString(16)))}};let Ie,qe,Fe,Ue={};const Re=e=>{var t;const o=document.createElement("div");let n;o.id=e.uid,o.className="markmeid-note-node";const i=y(e.selector);if(!i)return;const a=k(i),{top:r,left:s}=E(a,e.selector.position);var d;e.status===L.Closed&&o.classList.add("note-closed"),o.title=`[${e.type.toUpperCase()}]:${e.value}`,o.textContent=(d=null===(t=e.user)||void 0===t?void 0:t.email)?null==d?void 0:d.charAt(0):"M",e.selector.overflowNode&&(n=((e,t,o,n,i)=>{const a=w(o),r=N(a),s=document.createElement("div"),d=document.createElement("div");return s.id=`${e.uid}-shadow`,s.style.position="absolute",s.style.top=`${r.top}px`,s.style.left=`${r.left}px`,s.style.width=`${r.width}px`,s.style.height=`${r.height}px`,s.style.overflow="hidden",d.style.height=`${a.scrollHeight}px`,d.style.width=`${a.scrollWidth}px`,d.style.zIndex="-1",s.appendChild(d),t.style.left=n-r.left+"px",t.style.top=i-r.top+"px",s.appendChild(t),a.addEventListener("scroll",(()=>{s.scrollTop=a.scrollTop,s.scrollLeft=a.scrollLeft})),s.scrollTop=a.scrollTop,s.scrollLeft=a.scrollLeft,z.appendChild(s),s})(e,o,e.selector.overflowNode,s,r)),e.selector.overflowNode||(o.style.left=`${s}px`,o.style.top=`${r}px`,z.appendChild(o)),Ue[e.uid]={container:{node:i,coordinates:{x:Math.round(a.left),y:Math.round(a.top)}},note:o,shadowContainer:n},((e,t)=>{t.style.boxShadow="0 0 2px 2px hsla(0,0%,96%,.8)",t.style.filter="brightness(1.25)",e===j.Bug?t.classList.add("bug-highlight"):e===j.Question?t.classList.add("question-highlight"):e===j.Feature&&t.classList.add("feature-highlight"),setTimeout((()=>{t.style.boxShadow="none",t.style.filter="brightness(1)",t.style.removeProperty("box-shadow"),t.style.removeProperty("filter")}),300)})(e.type,o),De(e,o)},Ye={hideNotesByClassName:()=>{Array.from(z.getElementsByClassName("markmeid-note-node")).forEach((e=>e.remove()))},drawAndAdjustNotes:e=>{const t=m(s.getState());if(e&&0!==e.length)return t?e.filter((({page:{url:e}})=>e===location.pathname)).forEach(Re):e.forEach(Re);Ue={}},updateNotesPosition:()=>{const e=s.getState(),t=c(e),o=m(e);t.forEach((async e=>{var t,n,i;const{selector:a}=e,r=y(a),s=null===(n=null===(t=Ue[e.uid])||void 0===t?void 0:t.container)||void 0===n?void 0:n.coordinates,d=null===(i=Ue[e.uid])||void 0===i?void 0:i.note;if(!r||o&&e.page.url!==location.pathname)return void(d&&(d.remove(),delete Ue[e.uid]));if(!d&&o&&e.page.url===location.pathname)return void Re(e);const l=k(r);(null==s?void 0:s.x)===Math.round(l.left)&&(null==s?void 0:s.y)===Math.round(l.top)||(Ue[e.uid].container.coordinates={x:Math.round(l.left),y:Math.round(l.top)},((e,t,o)=>{const{top:n,left:i}=E(t,e.selector.position);if(e.selector.overflowNode){const t=Ue[e.uid].shadowContainer,a=N(t);t.style.top=`${a.top}px`,t.style.left=`${a.left}px`,t.style.width=`${a.width}px`,t.style.height=`${a.height}px`,o.style.left=`${i-a.left+t.scrollLeft}px`,o.style.top=`${n-a.top+t.scrollTop}px`}else o.style.left=`${i}px`,o.style.top=`${n}px`})(e,l,d))}))},compareNoteArrays:(e,t)=>{const o=new Set(e.map((e=>e.uid)));return t.filter((e=>!o.has(e.uid)))},handleNoteLayout:()=>{z.appendChild(R);const e=t=>{t.composedPath().some((e=>e===_))||(_.style.display="none",document.removeEventListener("click",e))};document.addEventListener("contextmenu",(t=>{const o=s.getState();if(!d(o)||!l(o))return;t.preventDefault(),Fe=C(t),Ie=t.clientX,qe=t.clientY+window.scrollY;const n=window.innerWidth-Ie,i=window.innerHeight-qe,a=qe;_.style.left=n>=164?Ie+"px":Ie-164+"px",_.style.top=i>=200?qe+"px":a>=200?qe-200+"px":"0px",_.style.display="block",ee.addEventListener("click",(()=>{_.style.display="none",document.removeEventListener("click",e)})),document.addEventListener("click",e)})),Z.addEventListener("click",(async()=>{await Oe.addNote({screenPosition:{x:Ie,y:qe},resolution:{w:window.innerWidth,h:window.innerHeight},uid:He(),value:G.value,type:V.value,page:{url:location.pathname},selector:Fe,metaInfo:{userAgent:navigator.userAgent}}),G.value="",_.style.display="none",document.removeEventListener("click",e)}))},redrawNote:e=>{Ue[e.uid].note.remove(),delete Ue[e.uid],Re(e)}};let Qe=location.pathname;const Xe=ae(Ye.updateNotesPosition,500),_e=new MutationObserver((async()=>{if(location.pathname!==Qe){Qe=location.pathname;const e=document.getElementById("markmeid-note-popup-block");e&&(e.style.display="none")}Xe()})),Je=()=>_e.observe(document,{subtree:!0,childList:!0,attributes:!0}),We=()=>_e.disconnect(),{getState:Ge,dispatch:Ke,subscribe:Ve}=s,Ze=ae(Ye.updateNotesPosition,250);Ve(((e,t)=>{if(!t.notes)return;const o=Ye.compareNoteArrays(e.notes,t.notes);o&&o.length&&(window.removeEventListener("resize",Ze),Ye.drawAndAdjustNotes(o),window.addEventListener("resize",Ze))}));exports.bootstrap=async t=>{var o;Ke((o=t,{type:e.SetConfig,payload:o}));try{ue(),Ye.handleNoteLayout(),d(Ge())&&(Ke(i(await Le())),Ke(a(await Oe.getNotes())),fe(),Je())}catch(e){console.error("Couldn't start the markmeid application")}};
